{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Metadata": {
        "AWS::CloudFormation::Designer": {
            "ed15b8ca-df8e-4a24-b41c-4cc0ae3f50ab": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 216,
                    "y": 172
                },
                "z": 0,
                "embeds": []
            },
            "f7d6bbe1-042d-4db7-b2cc-f84cc3a7bb73": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 450,
                    "y": 190
                },
                "z": 1,
                "embeds": [],
                "references": [
                    "0829b4b2-b003-4517-81bb-b1d3e39372a9",
                    "276785cf-01f3-4dda-897d-658d37e69f34"
                ]
            },
            "276785cf-01f3-4dda-897d-658d37e69f34": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 550,
                    "y": 190
                },
                "z": 1,
                "embeds": []
            },
            "1742a533-6646-452e-af93-c43ed9fa8257": {
                "source": {
                    "id": "f7d6bbe1-042d-4db7-b2cc-f84cc3a7bb73"
                },
                "target": {
                    "id": "276785cf-01f3-4dda-897d-658d37e69f34"
                },
                "z": 1
            },
            "0829b4b2-b003-4517-81bb-b1d3e39372a9": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 450,
                    "y": 90
                },
                "z": 1,
                "embeds": []
            },
            "f16ccdbc-9e13-498c-aa60-d96a5a290d82": {
                "source": {
                    "id": "f7d6bbe1-042d-4db7-b2cc-f84cc3a7bb73"
                },
                "target": {
                    "id": "0829b4b2-b003-4517-81bb-b1d3e39372a9"
                },
                "z": 13
            },
            "9c963997-f2b5-4b2a-ae30-731566a1b749": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 417.16666193803167,
                    "y": 213.66666287183773
                },
                "z": 0
            },
            "6a120fc1-2439-44fd-8613-6598df97466d": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 240,
                    "y": 90
                },
                "z": 1,
                "embeds": []
            },
            "30eaa50f-c52f-47d5-9e81-0596683e6d48": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 310,
                    "y": 160
                },
                "z": 1,
                "embeds": []
            },
            "14efb56a-84d8-4fc0-8358-54ccce20618f": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 310,
                    "y": 90
                },
                "z": 1,
                "embeds": []
            },
            "13e68dcb-eab9-4959-bc26-df5da3ba06ee": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 240,
                    "y": 160
                },
                "z": 1,
                "embeds": []
            },
            "3d3a5af3-1816-4690-83fc-83291ca5d36b": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 240,
                    "y": 230
                },
                "z": 1,
                "embeds": []
            },
            "35ce2b69-aef1-4c70-a6b4-1d5b34c1b921": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 310,
                    "y": 230
                },
                "z": 1,
                "embeds": []
            },
            "fb2c858c-e463-4480-aa05-9481612ace19": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 840,
                    "y": 300
                },
                "z": 1,
                "embeds": []
            },
            "7268dfc7-b1b4-44b5-b530-d67400efecbe": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 840,
                    "y": 110
                },
                "z": 1,
                "embeds": [],
                "isassociatedwith": [
                    "7929cb6c-9d2a-49a6-b026-cf1460f6a6f8"
                ]
            },
            "7929cb6c-9d2a-49a6-b026-cf1460f6a6f8": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 840,
                    "y": 210
                },
                "z": 1,
                "embeds": [],
                "ismemberof": [
                    "5d7a7708-1753-41c0-816b-dbb841fd98ff"
                ],
                "isrelatedto": [
                    "c4ac9e67-759d-4b1f-a090-fab10046d8f9"
                ]
            },
            "5d7a7708-1753-41c0-816b-dbb841fd98ff": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 720,
                    "y": 210
                },
                "z": 1,
                "embeds": []
            },
            "c4ac9e67-759d-4b1f-a090-fab10046d8f9": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 970,
                    "y": 250
                },
                "z": 1,
                "embeds": [],
                "isassociatedwith": [
                    "fb2c858c-e463-4480-aa05-9481612ace19"
                ]
            },
            "ca2f1ebe-ca63-492c-b132-f4374f96caf5": {
                "source": {
                    "id": "7268dfc7-b1b4-44b5-b530-d67400efecbe"
                },
                "target": {
                    "id": "7929cb6c-9d2a-49a6-b026-cf1460f6a6f8"
                },
                "z": 11
            }
        }
    },
    "Resources": {
        "WillowService": {
            "Type": "AWS::ECS::Service",
            "Properties": {
                "DesiredCount": 1,
                "TaskDefinition": {
                    "Ref": "WillowTaskDef"
                },
                "Cluster": {
                    "Ref": "WillowClusterECS"
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "f7d6bbe1-042d-4db7-b2cc-f84cc3a7bb73"
                }
            }
        },
        "WillowClusterECS": {
            "Type": "AWS::ECS::Cluster",
            "Properties": {
                "ClusterName": "willow"
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "276785cf-01f3-4dda-897d-658d37e69f34"
                }
            }
        },
        "WillowTaskDef": {
            "Type": "AWS::ECS::TaskDefinition",
            "Properties": {
                "ContainerDefinitions": [
                    {
                        "Essential": true,
                        "Image": "835219480274.dkr.ecr.eu-west-2.amazonaws.com/willow-fedora:latest",
                        "MountPoints": [
                            {
                                "ContainerPath": "/fcrepo4_home/",
                                "SourceVolume": "Fcrepo4_Home"
                            },
                            {
                                "ContainerPath": "/fcrepo4_data/",
                                "SourceVolume": "Fcrepo4_Data"
                            }
                        ],
                        "MemoryReservation": 500,
                        "Environment": [
                            {
                                "Name": "POSTGRES_USER",
                                "Value": "postgres"
                            },
                            {
                                "Name": "POSTGRES_PASSWORD",
                                "Value": "password"
                            },
                            {
                                "Name": "SECRET_KEY_BASE_TEST",
                                "Value": "sample_test_key"
                            },
                            {
                                "Name": "WILLOW_EMAIL",
                                "Value": "willow@cottagelabs.com"
                            },
                            {
                                "Name": "WILLOW_PASSWORD",
                                "Value": "sample_willow_pass"
                            },
                            {
                                "Name": "WILLOW_NAME",
                                "Value": "Willow (Admin)"
                            },
                            {
                                "Name": "WILLOW_EXPOSED_PORT",
                                "Value": "80"
                            },
                            {
                                "Name": "GEOBLACKLIGHT_EXPOSED_PORT",
                                "Value": "81"
                            }
                        ],
                        "Name": "fedora"
                    },
                    {
                        "Essential": true,
                        "Image": "835219480274.dkr.ecr.eu-west-2.amazonaws.com/willow-redis:latest",
                        "MountPoints": [
                            {
                                "ContainerPath": "/data",
                                "SourceVolume": "Redis_Data"
                            }
                        ],
                        "MemoryReservation": 250,
                        "Name": "redis"
                    },
                    {
                        "Essential": true,
                        "Image": "835219480274.dkr.ecr.eu-west-2.amazonaws.com/willow-solr:latest",
                        "MountPoints": [
                            {
                                "ContainerPath": "/solr_home",
                                "SourceVolume": "Solr_Home"
                            }
                        ],
                        "MemoryReservation": 250,
                        "Name": "solr"
                    },
                    {
                        "Essential": true,
                        "Image": "835219480274.dkr.ecr.eu-west-2.amazonaws.com/willow:latest",
                        "Links": [
                            "redis",
                            "solr",
                            "fedora"
                        ],
                        "MountPoints": [
                            {
                                "ContainerPath": "/derivatives",
                                "SourceVolume": "Derivatives"
                            }
                        ],
                        "MemoryReservation": 500,
                        "Environment": [
                            {
                                "Name": "POSTGRES_USER",
                                "Value": "postgres"
                            },
                            {
                                "Name": "POSTGRES_PASSWORD",
                                "Value": "password"
                            },
                            {
                                "Name": "SECRET_KEY_BASE_TEST",
                                "Value": "sample_test_key"
                            },
                            {
                                "Name": "WILLOW_EMAIL",
                                "Value": "willow@cottagelabs.com"
                            },
                            {
                                "Name": "WILLOW_PASSWORD",
                                "Value": "sample_willow_pass"
                            },
                            {
                                "Name": "WILLOW_NAME",
                                "Value": "Willow (Admin)"
                            },
                            {
                                "Name": "WILLOW_EXPOSED_PORT",
                                "Value": "80"
                            },
                            {
                                "Name": "GEOBLACKLIGHT_EXPOSED_PORT",
                                "Value": "81"
                            },
                            {
                                "Name": "SECRET_KEY_BASE_PRODUCTION",
                                "Value": "sample_prod_key"
                            },
                            {
                                "Name": "WILLOW_SEED",
                                "Value": "false"
                            },
                            {
                                "Name": "GEOBLACKLIGHT_SEED",
                                "Value": "false"
                            },
                            {
                                "Name": "RAILS_SERVE_STATIC_FILES",
                                "Value": "true"
                            },
                            {
                                "Name": "MESSAGE_STREAM",
                                "Value": "false"
                            },
                            {
                                "Name": "MESSAGE_STREAM_NAME",
                                "Value": "willow-message-stream"
                            },
                            {
                                "Name": "MESSAGE_STREAM_SHARD_COUNT",
                                "Value": "1"
                            },
                            {
                                "Name": "MESSAGE_STREAM_PARTITION_KEY",
                                "Value": "willow"
                            },
                            {
                                "Name": "MESSAGE_STREAM_REGION",
                                "Value": "eu-west-2"
                            }
                        ],
                        "Name": "willow",
                        "PortMappings": [
                            {
                                "ContainerPort": 3000,
                                "HostPort": 80
                            }
                        ]
                    }
                ],
                "Family": "willow",
                "Volumes": [
                    {
                        "Host": {
                            "SourcePath": "solr_home"
                        },
                        "Name": "Solr_Home"
                    },
                    {
                        "Host": {
                            "SourcePath": "redis_data"
                        },
                        "Name": "Redis_Data"
                    },
                    {
                        "Host": {
                            "SourcePath": "derivatives"
                        },
                        "Name": "Derivatives"
                    },
                    {
                        "Host": {
                            "SourcePath": "fcrepo4_home"
                        },
                        "Name": "Fcrepo4_Home"
                    },
                    {
                        "Host": {
                            "SourcePath": "fcrepo4_data"
                        },
                        "Name": "Fcrepo4_Data"
                    }
                ]
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "0829b4b2-b003-4517-81bb-b1d3e39372a9"
                }
            }
        },
        "WillowSolrECR": {
            "Type": "AWS::ECR::Repository",
            "Properties": {
                "RepositoryName": "willow-solr"
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "35ce2b69-aef1-4c70-a6b4-1d5b34c1b921"
                }
            }
        },
        "WillowRedisECR": {
            "Type": "AWS::ECR::Repository",
            "Properties": {
                "RepositoryName": "willow-redis"
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "3d3a5af3-1816-4690-83fc-83291ca5d36b"
                }
            }
        },
        "WillowFedoraECR": {
            "Type": "AWS::ECR::Repository",
            "Properties": {
                "RepositoryName": "willow-fedora"
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "30eaa50f-c52f-47d5-9e81-0596683e6d48"
                }
            }
        },
        "WillowAppECR": {
            "Type": "AWS::ECR::Repository",
            "Properties": {
                "RepositoryName": "willow"
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "6a120fc1-2439-44fd-8613-6598df97466d"
                }
            }
        },
        "ecsInstanceRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Action": "sts:AssumeRole",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "ec2.amazonaws.com"
                            }
                        }
                    ]
                },
                "ManagedPolicyArns": ["arn:aws:iam::aws:policy/service-role/AmazonEC2ContainerServiceforEC2Role"],
                "Path": "/"
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "fb2c858c-e463-4480-aa05-9481612ace19"
                }
            }
        },
        "ecsInstanceProfile": {
            "Type": "AWS::IAM::InstanceProfile",
            "Properties": {
                "Path": "/",
                "Roles": [
                    {
                        "Ref": "ecsInstanceRole"
                    }
                ]
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "c4ac9e67-759d-4b1f-a090-fab10046d8f9"
                }
            }
        },
        "WillowECSGroup": {
            "Type": "AWS::AutoScaling::AutoScalingGroup",
            "Properties": {
                "DesiredCapacity": "1",
                "Tags": [],
                "MinSize": "1",
                "MaxSize": "1",
                "HealthCheckGracePeriod": 120,
                "LaunchConfigurationName": {
                    "Ref": "WillowECSLaunchConfiguration"
                },
                "AvailabilityZones": [
                    "eu-west-2a",
                    "eu-west-2b"
                ],
                "VPCZoneIdentifier": ["subnet-7aeef802", "subnet-b22115f8"],
                "HealthCheckType": "EC2"
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "7268dfc7-b1b4-44b5-b530-d67400efecbe"
                }
            }
        },
        "WillowECSLaunchConfiguration": {
            "Type": "AWS::AutoScaling::LaunchConfiguration",
            "Properties": {
                "UserData": "IyEvYmluL2Jhc2gKZWNobyAiRUNTX0NMVVNURVI9d2lsbG93IiA+PiAvZXRjL2Vjcy9lY3MuY29uZmln",
                "IamInstanceProfile": {
                    "Ref": "ecsInstanceProfile"
                },
                "AssociatePublicIpAddress": true,
                "InstanceMonitoring": true,
                "BlockDeviceMappings": [
                    {
                        "DeviceName": "/dev/xvda",
                        "Ebs": {
                            "DeleteOnTermination": true,
                            "SnapshotId": "snap-03798fceb166952d0",
                            "VolumeSize": 8,
                            "VolumeType": "gp2"
                        }
                    },
                    {
                        "DeviceName": "/dev/xvdcz",
                        "Ebs": {
                            "DeleteOnTermination": true,
                            "Encrypted": false,
                            "VolumeSize": 30,
                            "VolumeType": "gp2"
                        }
                    }
                ],
                "KeyName": "willow-ecs",
                "SecurityGroups": [
                    {
                        "Ref": "PublicHttpHttpsSshSecurityGroup"
                    }
                ],
                "ImageId": "ami-ff15039b",
                "InstanceType": "t2.medium"
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "7929cb6c-9d2a-49a6-b026-cf1460f6a6f8"
                }
            }
        },
        "PublicHttpHttpsSshSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupDescription": "Public access to HTTP(S) and SSH",
                "SecurityGroupEgress": [
                    {
                        "IpProtocol": "-1",
                        "CidrIp": "0.0.0.0/0"
                    }
                ],
                "SecurityGroupIngress": [
                    {
                        "FromPort": 80,
                        "CidrIp": "0.0.0.0/0",
                        "ToPort": 80,
                        "IpProtocol": "tcp"
                    },
                    {
                        "FromPort": 22,
                        "CidrIp": "0.0.0.0/0",
                        "ToPort": 22,
                        "IpProtocol": "tcp"
                    },
                    {
                        "FromPort": 443,
                        "CidrIp": "0.0.0.0/0",
                        "ToPort": 443,
                        "IpProtocol": "tcp"
                    }
                ],
                "VpcId": "vpc-925bb2fb"
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "5d7a7708-1753-41c0-816b-dbb841fd98ff"
                }
            }
        }
    }
}